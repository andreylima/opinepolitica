
//google maps api

jQuery(document).ready(function(){

var map;
var denuncias;


function initialize() {
  var mapOptions = {
    zoom: 13,
    center: new google.maps.LatLng(-18.8595948, -41.9529012)
  };
  map = new google.maps.Map(document.getElementById('mapagv'),
      mapOptions);
  map.setOptions(mapOptions);

 put_markers_on_map(map);


}

google.maps.event.addDomListener(window, 'load', initialize);


function initialize2() {

var animation = google.maps.Animation.BOUNCE;
var position = new google.maps.LatLng(-18.8595948, -41.9529012);
  var mapOptions = {
    zoom: 13,
    center: position,
    scrollwheel: false,

  };
  map = new google.maps.Map(document.getElementById('mapagv-register'),
      mapOptions);

  marker = new google.maps.Marker({
      map:map,
      draggable: true,
      animation: animation,
      position: position
  });

    var $addressInput = jQuery('.search-adress')[0];
  var searchOptions = {
    componentRestrictions: {country: 'br'}
  };

  var autoComplete = new google.maps.places.Autocomplete($addressInput, searchOptions);
  autoComplete.bindTo('br', map);

  google.maps.event.addListener(autoComplete, 'place_changed', function() {
    geocodePosition(autoComplete.getPlace().geometry.location);
    if(marker) {
      map.setCenter(autoComplete.getPlace().geometry.location);
      map.setZoom(14);
      marker.setPosition(autoComplete.getPlace().geometry.location);
    }
  });

  google.maps.event.addListener(marker, 'dragend', function(){
    geocodePosition(marker.position);
    marker.setAnimation(null);
  });

}

google.maps.event.addDomListener(window, 'load', initialize2);


var geocodePosition = function(pos){
  var city;
  var bairro = null;
  geocoder = new google.maps.Geocoder();
  geocoder.geocode({
      latLng: pos
  },function(results, status) {
    if (status == google.maps.GeocoderStatus.OK){
      if(map){
        jQuery('#lat').val(results[0].geometry.location.lat());
        jQuery('#lng').val(results[0].geometry.location.lng());
       	jQuery('#addressField').val(results[0].formatted_address);
        jQuery('.active-adress').addClass('active').html('<span class="icon map-marker"></span> &nbsp;'+results[0].formatted_address);
      }

      var arrAddress = results[0].address_components;
      jQuery.each(arrAddress, function (i, address_component) {
        if (address_component.types[0] == "locality")  //"route", "country", "postal_code_prefix", "street_number"
            city = address_component.long_name;
            jQuery('#city').val(city);
      });

      bairro = results[0].address_components[2].long_name;
      if(bairro == city)
        bairro = results[0].address_components[3].long_name;

      var estado = jQuery('#state-name').val();
      if(bairro == estado)
        bairro = null;

      if(bairro)
        jQuery('#denuncia_bairro').val(bairro);
    }else
      jQuery("#dragMap").append('Não foi possível determinar sua localização'+status);
  });
}



var denuncia_completa = [];


var put_markers_on_map = function(map){


  jQuery.ajax({
    type: 'POST',
    url: myAjax.ajaxurl,
    data: 'action=get_denuncias',
    success: function(response) {
    
    denuncia_completa = response;
    add_markers(response, map);

    }


});

}

var markers = [];

function add_markers(response, map)
{
  
  var infoWindowList = [];
  var j;
  var response = JSON.parse(response);

  
 
  for (var i=0,len=response.length; i < len; i++) {
    var current = response[i];
    var pin = ((current.situacao_denuncia == "resolvida") ? "pin_2" : "pin_1") ;
    var situacao = ((current.situacao_denuncia == "resolvida") ? "Resolvida" : "Não Resolvida") ;
    marker = new google.maps.Marker({
      position: new google.maps.LatLng(current.latitude, current.longitude),
      map: map,
      icon: templateDir+'/assets/img/'+pin+'.png',
    });

    var link_video = current.link_video.split('=');
    var link_video = link_video[1];
    var date = current.data.split('/'),
        orderedDate = [date[1], date[0], date[2]],
        infowindow = new google.maps.InfoWindow({maxWidth: 300}),
        htmlContent = '<div class="hc-info-window">'
        +  '<h4 class="hc-info-title"><a  href="'+current.permalink+'">'+current.titulo+'</a></h4>'
        +  '<span class="flaticon-pin56 local-denuncia">&nbsp;'+current.local_denuncia+'</span>'
        + '<iframe id="link_video" style="width:300px;height:215px;background-color:black"  src="//www.youtube.com/embed/'+link_video+'" frameborder="0" allowfullscreen ALT="carregando video"></iframe>'
        +  '<div class="hc-info-box">'
        +  '<label for="data-denuncia">Data da Denúncia:</label>'
        +  '<h6 class="flaticon-calendar146 data-denuncia">&nbsp;'+orderedDate.join('/')+'</h6>'
        +  '<label for="situacao_denuncia" class="situacao-label">Situação:</label>' 
        + '<input type="text" name="situacao_denuncia" value="'+situacao+'" id="situacao_denuncia" disabled>'
        + '<a  href="'+current.permalink+'" class="qtd-comments-denuncia" ><div class="flaticon-comments16 ">'+current.qtd_comments_denuncia+'</div></a>'
        +  '<a href="'+current.permalink+'" class="button-info-denuncia">+ Ver Comentários</a></div>'
        +  '</div>';

    markers.push(marker);
    infowindow.setContent(htmlContent);
    infoWindowList.push(infowindow);

    google.maps.event.addListener(marker, 'click', (function(marker, j) {

      return function () {

        infoWindowList.map(function(el,id,arr){ el.close(); });
        infoWindowList[markers.indexOf(marker)].open(map, marker);
      }
    })(marker, j));

    // var lastReport = buildLastReportContent(current, date, i);
    // $markersList.append(lastReport);
    // $('.trigger-last-report').on('click', function(e) {
    //   var $anchor = $(this),
    //       index = $anchor.data('index');
    //   console.log(index);
    //   google.maps.event.trigger(markers[index], 'click');
    // });
  }


  //   $markersList.scroller({
  //   trackMargin: 10,
  //   handleSize: 40
  // });

}




function setAllMap(map) {

  alert(markers);

  for (var i = 0; i < markers_bairro.length; i++) {
    markers_bairro[i].setMap(map);
  }
}

// Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
  setAllMap(null);
}

function setmarkers()
{
  setAllMap(map);

}


jQuery("#clear").click(function(){  alert(denuncia_completa)  });

jQuery("#clear2").click(function(){  setmarkers()  });
















});